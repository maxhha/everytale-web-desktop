<!DOCTYPE html>
<html>
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- CSS -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:300,400,500" rel="stylesheet">
    <link rel="stylesheet" href="/css/custom.css">

    <title>Расписание занятий</title>
  </head>
  <body>
    <div class="d-flex flex-column" style="width: 100vw; height: 100vh;">
        <!-- header bar -->
        <div class= "flex-shrink-0 flex-grow-0 d-flex justify-content-between timetable-header">
            <div class="d-flex">
                <div class="logo-top-bar">
                    <img src="/img/everytale-logo.svg">
                </div>

                <div class="d-flex d-flex-row timetable-view-week">
                    <h4 class="d-none d-md-block">Расписание занятий</h4>
                </div>
            </div>
            <div class="d-flex">
                <div class="d-flex timetable-mainmenu">
                    <a class="selected">
                        Расписание
                    </a>
                    <a>
                        Библиотека
                    </a>
                </div>
                <div class="search-btn"></div>
                <div class="profile-small">
                    <img src="/img/profile.png">
                </div>
            </div>
        </div>
        <!--/ header bar -->

        <div class="d-flex row-flex-xl-nowrap content">

            <div class = "filter-sidebar hidden">
                <span style="left:100%; position:relative; top: 0.5rem;">
                    <div class="toggle-filters-menu-btn"></div>
                </span>
            </div>

            <div class="week-list-scroll"></div>
        </div>
    </div>
    <!-- Templates -->
    <script id="filter-parameter-tmpl" type="text/x-handlebars-template">
        <div class="filter-parameter">
            <div class="filter-header">
                <div class="d-flex">
                    <img src="{{img}}">
                    <h5>{{name}}</h5>
                </div>
            </div>
            <ul class="filter-categories-list">
                {{#each category}}
                <li class="filter-category">
                    <div class="d-flex justify-content-between category-header">
                        <h5 class="category-name">{{this.name}}</h5>
                        <div class="open-category-btn">
                            <div class="chevron"></div>
                        </div>
                    </div>
                    <div class="category-positions">
                        <div class="collapse">
                            {{#each position}}
                            <input type="checkbox" id="param{{this.id}}" class="list-checkbox" {{#if this.checked}}checked{{/if}}>
                            <label for="param{{this.id}}">{{this.name}}</label>
                            {{/each}}
                        </div>
                    </div>
                </li>
                {{/each}}
            </ul>
        </div>
    </script>
    <script id="day-tmpl" type="text/x-handlebars-template">
        <div class="day-place {{#if today}}current{{/if}}">
            <div class="day-card">

                <div class="d-flex justify-content-between day-header">
                    <div class="weekday">
                        {{name}}
                    </div>
                    <div class="d-flex justify-content-between flex-grow-1">
                        <div class="date">{{date}}</div>
                        <div class="today-label">Сегодня</div>
                    </div>
                </div>
                {{#each events}}

                {{#if this.isOnline}}
                <div class="event-online">Сейчас онлайн</div>
                {{else}}
                    {{#if this.isCurrent}}
                        <!-- Трансляция вот-вот начнётся-->
                    {{/if}}
                {{/if}}
                <div class="timetable-event {{#if this.isCurrent}}current{{/if}} {{#if this.isUpcoming}}upcoming{{/if}}">
                    <div class="d-flex event-header">
                        <div class="flex-shrink-0 flex-grow-0">
                            <div class="event-start-time">{{this.timestart}}</div>
                            <div class="event-finish-time">{{this.timefinish}}</div>
                        </div>
                        <a class="event-name" href="{{this.url}}">{{this.name}}</a>
                    </div>
                    <div class="d-flex justify-content-between event-icons-bar">
                        <div class="d-flex event-info">

                            {{#if this.lecturer}}
                            <div class="info-position">
                                <div class="event-icon icon-lecturer"></div>
                                <label title="{{this.lecturer}}">{{this.lecturer}}</label>
                            </div>
                            {{/if}}

                            {{#if this.place}}
                            <div class="info-position">
                                <div class="event-icon icon-place"></div>
                                <label title="{{this.place}}">{{this.placeShort}}</label>
                            </div>
                            {{/if}}

                            {{#if this.info}}
                            <div class="info-position">
                                <div class="event-icon icon-info"></div>
                                <label title="{{this.info}}">{{this.infoShort}}</label>
                            </div>
                            {{/if}}

                        </div>
                        <div class="d-flex justify-content-end">
                            <span class="event-icon icon-paper {{#if this.hasDocument}}{{else}}disabled{{/if}}"></span>
                            <span class="event-icon icon-clip {{#if this.hasFile}}{{else}}disabled{{/if}}"></span>
                        </div>
                    </div>
                </div>
                {{/each}}
            </div>
        </div>
    </script>
    <script id="weekdayNames" type="text/json">
        ["Воскресение","Понедельник","Вторник","Среда","Четверг","Пятница","Суббота"]
    </script>
    <!-- END Templates -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.1.1/handlebars.min.js" integrity="sha256-Mki72593zH3nxiQrW1mskmSOAXOep8FVIK0ozKFISyY=" crossorigin="anonymous"></script>
    <script src="/js/sugar.min.js"></script>
    <script>
        Sugar.extend();

        (function(){

            var getUserFilters = function(callback){
                // There should be a call to the server.
                // Parsed result of the call follows below.
                var filters = [{
                    name: "Подключенный спискок",
                    img : "/img/eye.svg",
                    category: [
                        {
                            name: "МГТУ им Н.Э. Баумана",
                            position: [{
                                name: "ИУ9-43Б",
                                id: "1"
                            }, {
                                name: "Технопарк Python-14",
                                id: "2",
                            }]
                        },{
                            name: "Digital Conference",
                            position: [{
                                name: "NLP/Machine Learning",
                                id: "3"
                            }]
                        }
                    ]
                }];
                callback(filters);
            };

            var filterTempl = Handlebars.compile($("#filter-parameter-tmpl").html());

            var filtersView = function(filters){
                var target = $('.filter-sidebar');
                filters.forEach(function(filter){

                    filter.category.forEach(function(c){
                        c.position.forEach(function(p){
                            /* should be checked if it is a checkbox */
                            p.checked = true; /* so user can see all timetable */
                        });
                    });

                    target.append(filterTempl(filter));
                });
            };

            getUserFilters(filtersView);
        })();

        (function(){

            var getUserTimetable = function(dates, callback){
                // dates - array of Date()

                // There should be a call to the server.
                // Callback shuold get this array:
                /*

                var result = [{
                    date: Date(),
                    events: [{
                        name: "",
                        url: "/url/to/lecture/page",
                        timeStart: Date(),
                        timeFinish: Date(),
                        lecturer: "",
                        place: "",
                        info: "",
                        hasDocument: false,
                        hasFile: false,
                        isOnline: false
                    }, ...]
                }, ...]

                */
                /* generate some data to output */
                var eventNames = [
                    "Обыкновенные дифференциальные уравнения",
                    "Операционные системы",
                    "Алгоритмы компьютерной графики",
                    "Дискретная математика",
                    "Теория вероятностей",
                    "Физика",
                    "Программирование",
                    "Базы данных",
                    "Философия"
                ];
                var eventTimeStarts = [
                    "8:30","10:15","11:50",
                    "13:35", "15:20", "17:05",
                    "18:50", "21:00"];

                var lecturers = [
                    "Аксёнов М.С.",
                    "Лазарев Д.Г.",
                    "Хохлов Р.А.",
                    "Бобров Г.А.",
                    "Новиков Ф.В."
                ];

                var places = [
                    "СК\"Олимпийский\"",
                    "УЛК МГТУ им Баумана",
                    "ГК МГТУ им Баумана"];

                var infos = ["",
                    "Специальное машиностроение",
                    "Динамическое программирование",
                    "Линейные уравнения",
                    "Кривые второго порядка",
                    "Симплекс-метод",
                    "Философия Ницше",
                    "Моделирование движения молекул сахара в крепких растворах турецкого чая"
                ];

                var getRndIndx = function(arr){
                    return Math.floor(Math.random() * arr.length);
                };

                function gaussianRand() {
                  var rand = 0;

                  for (var i = 0; i < 6; i += 1) {
                    rand += Math.random();
                  }

                  return rand / 6;
                }

                result = dates.map(function(date){
                    var day = {};
                    day.date = date;
                    day.events = [];
                    var suturdayK = date.isSaturday() ? Math.random()*0.75 : 1;
                    var sundayK = date.isSunday() ? Math.random()*0.5 : 1;
                    var countEvents = Math.floor(suturdayK*sundayK*gaussianRand() * (eventTimeStarts.length+1));
                    var eventTimes = []
                    while(eventTimes.length < countEvents) {
                        var i = getRndIndx(eventTimeStarts);
                        if(eventTimes.indexOf(i) === -1)
                            eventTimes.push(i);
                    }

                    eventTimes = eventTimes.sort(function(a,b){return a - b})
                    for(var i = 0; i < eventTimes.length; i++){
                        var event = {};
                        event.name = eventNames[getRndIndx(eventNames)];
                        event.url = "#";
                        var d = new Date(date);

                        var time = eventTimeStarts[eventTimes[i]]
                            .split(":")
                            .map(function(x){return parseInt(x)});

                        d.setHours(time[0], time[1]);
                        event.timeStart = d;
                        event.timeFinish = new Date(d - (-90*60*1000)); //JS MAGIC
                        event.lecturer = lecturers[getRndIndx(lecturers)];
                        event.place = places[getRndIndx(places)];
                        event.info = infos[getRndIndx(infos)];
                        event.hasDocument = Math.random() < 0.5;
                        event.hasFile = Math.random() < 0.5;
                        event.isOnline = event.timeStart <= Date.now()
                            && Date.now() <= event.timeFinish;
                        day.events.push(event);
                    }
                    return day;
                });

                callback(result);
            };

            var dayTmpl = Handlebars.compile($("#day-tmpl").html());

            var daysView = function(days){
                var target = $(".week-list-scroll")

                for(var i = 0; i < days.length; i++){
                    var day = days[i];
                    day.name = day.date.format("{Weekday}", "ru").capitalize();
                    day.today = day.date.isToday();
                    day.date = day.date.format("%d.%m");
                    day.events.forEach(function(e){
                        var mx_len = 22 + (e.hasFile ? 0:4) + (e.hasDocument ? 0:4);
                        e.placeShort = e.place.length > mx_len ? e.place.first(mx_len) + '...' : e.place;
                        e.infoShort = e.info.length > mx_len ? e.info.first(mx_len) + '...' : e.info;
                        e.timestart = e.timeStart.format("%R");
                        e.timefinish = e.timeFinish.format("%R");
                        if (e.timeStart <= Date.now()) {
                            if (Date.now() <= e.timeFinish) {
                                e.isCurrent = true
                            }
                        } else {
                            e.isUpcoming = true;
                        }


                    });
                    target.append(dayTmpl(day));
                }
            };

            window.reloadTimetable = function(dateStart){
                var dates = [];
                var d = dateStart || new Date();
                d = d.addDays(1-d.getDay());
                for(var i = 0; i < 7; i++){
                    dates.push(new Date(d).addDays(i));
                }
                $(".day-place").remove();

                getUserTimetable(dates, daysView);
            }
            reloadTimetable();
        })();

        /* UI listeners */
        $(".category-header").on("click", function(){
            if ($(this).is('.show')) {
                $(this).removeClass("show");
                $(this).parent().find(".collapse").hide(350);
            } else {
                $(this).addClass("show");
                var collapseItem = $(this).parent().find(".collapse");
                collapseItem.show(350);
            }
        });

        $(".toggle-filters-menu-btn").on("click", function(){
            if ($(this).is('.show')) {
                $(this).removeClass("show");
                $(".filter-sidebar").addClass('hidden');
                $(".filter-parameter").css("display", 'none');
            } else {
                $(this).addClass("show");
                $(".filter-sidebar").removeClass('hidden');
                $(".filter-parameter").css("display", 'none');
            }
        });
        $(".filter-sidebar").on('transitionend', function(){
            if (!$(this).is('.hidden')){
                $(".filter-parameter").css("display", 'block');
            }
        });


    </script>
  </body>
</html>
